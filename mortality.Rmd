---
title: "Survival Analysis of Mortality of Adjuvant Chemotherapy for Colon Cancer"
author: "Yijia Jiang, Ziyan Xu"
date: "`r Sys.Date()`"
output: pdf_document
---


```{r, message=FALSE, include=FALSE}
library("tidyverse")
library("survival")
library("ggplot2")
library("survminer")
library("MASS")
library("gridExtra")
```


# 1. Data Tidy 
Recall that there are two records for each patient indicated by the event type (etype) variable, where etype == 1 refers to the event of a recurrence and etype == 2 indicates death. In order to answer our first research question, which is to study the time until death, we must create a marginal model by subsetting the colon data to only include the event of mortality. 

```{r, message=FALSE, warning=FALSE}
# import the dataset from survival package
colon <- survival::colon

# tidy mortality dataset
colon.death <- colon %>% 
  dplyr::select(-id, -study, -nodes) %>% 
  drop_na() %>% 
  mutate(rx = as.factor(as.numeric(rx)),
         sex = as.factor(sex),
         obstruct = as.factor(obstruct),
         perfor = as.factor(perfor),
         adhere = as.factor(adhere),
         differ = as.factor(differ),
         extent = as.factor(extent),
         surg = as.factor(surg),
         node4 =as.factor(node4)) %>% 
  subset(etype == 2)
```

&nbsp;


# 2. Kaplan-Meier Survival Estimate

```{r, message=FALSE, warning=FALSE}
death.fit <- survfit(Surv(time,status) ~ rx, data = colon.death)
options(max.print = 10000)
print(summary(death.fit))
ggsurvplot(death.fit, conf.int = F, break.time.by = 500, pval = TRUE,
           font.x.size = 12, font.y.size = 12, font.legend.size = 9, surv.median.line = "hv",
           legend.title = "Treatment", legend.labs = c("Observation", "Levamisole","Levamisole+5-FU"),
           title = "Kaplan-Meier Curve for Colon Cancer Mortality \nby Treatment", 
           xlab = "Time (until death) in Days", 
           risk.table = T, risk.table.height = 0.25, risk.table.fontsize = 4, 
           tables.theme = theme_cleantable())
```

From the plot above, there is some indication that patients who received the adjuvant treatment with levamisole plus fluorouracil (Lev+5FU) have a higher survival probability than patients with no further treatment and patients who received the treatment with levamisole alone. The median survival time for observation group and levamisole group are approximately 2100 days and 2200 days. However, until the end of the trial, the survival probability of Levamisole+5-FU treatment group is greater than 50% as we fail to observe the curve doesn't cross 50%, which means the median survival is simply undefined.

&nbsp;


# 3. Log-Rank Test

Noticing the difference of survival probability between the three treatment groups, we do a Log-rank hypothesis test to test the null hypothesis of no difference among the three treatments in the mortality model.
```{r, message=FALSE, warning=FALSE}
survdiff(Surv(time, status) ~ rx, data = colon.death)
```

From this log-rank test, we get a p-value that is closed to 0.005, which is significant at a 0.05 level. We want to conclude that there is a significant difference among the three treatments in the mortality model.

&nbsp;


# 4. Cox PH Model 
## 4.1 Model Selection

We now use automatic stepwise selection with Akaike information criterion (AIC) to determine the covariates that best represent an appropriate cox proportional hazards model for the event of death. 

```{r, message=FALSE, warning=FALSE}
# fit all the variables in the model
d.model.full <- coxph(Surv(time, status) ~ . -etype, data = colon.death)

# stepwise selection with AIC criterion
d.model.aic <- step(d.model.full, direction = "both", k = 2)
```

The resulting model with the lowest AIC is:
Surv(time, status) ~ obstruct + differ + extent + surg + node4 + age + rx


Next, we used the Analysis of Deviance procedure to get the proper Likelihood Ratio Test to confirm if each of the covariates selected by the stepwise selection method is significant to include in the Cox Proportional Model.

```{r, message=FALSE, warning=FALSE}
anova(d.model.aic)
```

We can see that p-values for covariates "obstruct, differ, extent, surg, node4 and rx" are much smaller than 0.05, except for "age", indicating that they have a significant effect on time until death. Therefore, we will include these 6 covariates in our Cox PH model.

Therefore, we obtain the resulting model, which is Surv(time, status) ~ obstruct + differ + extent + surg + node4 + rx.

&nbsp;


## 4.2 Model Diagnostics 
### 4.2.1 Check proportionality of hazard ratios

**Log of Negative Log of Estimated Survival Function** 

To check the proportional hazards assumption for this model, we make diagnostic plots using log of negative log of estimated survival function. First comes to covariate obstruct.

```{r, message=FALSE, warning=FALSE}
d.obstruct.fit <- survfit(Surv(time, status) ~ obstruct, data = colon.death)
cloglog_obstruct <- ggsurvplot(d.obstruct.fit, conf.int = F, font.x.size = 12, font.y.size = 12, font.legend.size = 9,
                               fun = "cloglog",
                               xlim = c(20, 4000),
                               xlab = "Time (until death) in Days)",
                               title = "Log of Negative Log of Estimated Survival Function \nfor Colon Cancer Mortality by obstruct",
                               legend.title = "Obstruction of colon by tumour",
                               legend.labs = c("0-No", "1-Yes"))

cloglog_obstruct
```

According to the plot, the distance between two obstruct curves begin to narrow after 2000 days which causes some concern that the assumption might be violated. However, it is also reasonable to assume that the curves are wider apparent earlier in the study since there are less occurrences of death before 2000 days. Hence we believe it is best to ignore the noisiness of the plot since the curves are roughly parallel after 2000 days. Thus, the cox proportional hazards assumption is valid to use for "obstruct".


We continue to plot the C-log-log plot for the covariate differ.

```{r, message=FALSE, warning=FALSE}
d.differ.fit <- survfit(Surv(time, status) ~ differ, data = colon.death)
cloglog_differ <- ggsurvplot(d.differ.fit, conf.int = F, font.x.size = 12, font.y.size = 12, font.legend.size = 9,
                             fun = "cloglog",
                             xlim = c(20, 4000),
                             xlab = "Time (until death) in Days)",
                             title = "Log of Negative Log of Estimated Survival Function \nfor Colon Cancer Mortality by differ",
                             legend.title = "Differentiation of tumour",
                             legend.labs = c("1-Well", "2-Moderate","3-Poor"))

cloglog_differ
```

According to the plot, the curves in the C-log-log plot are crossing over after 300 days. The assumption of proportional hazard ratio between the three differ groups is violated as we fail to see three parallel lines against log time.


We continue to plot the C-log-log plot for the covariate extent.

```{r, message=FALSE, warning=FALSE}
d.extent.fit <- survfit(Surv(time, status) ~ extent, data = colon.death)
cloglog_extent <- ggsurvplot(d.extent.fit, conf.int = F, font.x.size = 12, font.y.size = 12, font.legend.size = 9,
                             fun = "cloglog",
                             xlim = c(20, 4000),
                             xlab = "Time (until death) in Days)",
                             title = "Log of Negative Log of Estimated Survival Function \nfor Colon Cancer Mortality by extent",
                             legend.title = "Extent of local spread",
                             legend.labs = c("1-Submucosa", "2-Muscle", "3-Serosa", "4-Contiguous structures"))

cloglog_extent
```

According to the plot, the curves in the C-log-log plot are crossing over after 100 days. The assumption of proportional hazard ratio of extent is violated as we fail to see four parallel lines against log time.


We continue to plot the C-log-log plot for the covariate surg.

```{r, message=FALSE, warning=FALSE}
d.surg.fit <- survfit(Surv(time, status) ~ surg, data = colon.death)
cloglog_surg <- ggsurvplot(d.surg.fit, conf.int = F, font.x.size = 12, font.y.size = 12, font.legend.size = 9,
                           fun = "cloglog",
                           xlim = c(20, 4000),
                           xlab = "Time (until death) in Days)",
                           title = "Log of Negative Log of Estimated Survival Function \nfor Colon Cancer Mortality by surg",
                           legend.title = "Time from surgery to registration",
                           legend.labs = c("0-Short", "1-Long"))

cloglog_surg
```

According to the plot, the distance between two surg curves begin to narrow after 100 days and becomes parallel to each other. We can assume that the cox proportional hazards assumption is valid to use for `surg`.


We continue to plot the C-log-log plot for the covariate node4.

```{r, message=FALSE, warning=FALSE}
d.node4.fit <- survfit(Surv(time, status) ~ node4, data = colon.death)
cloglog_node4 <- ggsurvplot(d.node4.fit, conf.int = F, font.x.size = 12, font.y.size = 12, font.legend.size = 9,
                            fun = "cloglog",
                            xlim = c(20, 4000),
                            xlab = "Time (until death) in Days)",
                            title = "Log of Negative Log of Estimated Survival Function \nfor Colon Cancer Mortality by node4",
                            legend.title = "More than 4 positive lymph nodes",
                            legend.labs = c("0-No", "1-Yes"))

cloglog_node4
```

According to the plot, the two curves in this C-log-log plot cross over at the beginning of the study but appear to be parallel to each other after 100 days. Since the data is oftentimes noisy at the beginning of the study, the cross over does not cause too much concern. Overall, we believe that the cox proportional assumption is appropriate for the covariate node4 since the curves are consistently parallel throughout most of the study.


We continue to plot the C-log-log plot for the covariate rx.

```{r, message=FALSE, warning=FALSE}
d.surg.fit <- survfit(Surv(time, status) ~ rx, data = colon.death)
cloglog_rx <- ggsurvplot(d.surg.fit, conf.int = F, font.x.size = 12, font.y.size = 12, font.legend.size = 9,
                         fun = "cloglog",
                         xlim = c(20, 4000),
                         xlab = "Time (until death) in Days)",
                         title = "Log of Negative Log of Estimated Survival Function \nfor Colon Cancer Mortality by rx",
                         legend.title = "Treatment",
                         legend.labs = c("Observation", "Levamisole","Levamisole+5-FU"))

cloglog_rx
```

According to the plot, the distance between three treatment curves begin to narrow after 2000 days which causes some concern that the assumption might be violated. However, it is also reasonable to assume that the curves are wider apparent earlier in the study since there are less occurrences of death before 2000 days. Hence we believe it is best to ignore the noisiness of the plot since the curves are roughly parallel after 2000 days. Thus, the cox proportional hazards assumption is valid to use for this covariate.



```{r, message=FALSE, warning=FALSE}
# combine all the cloglog plots and save them to a pdf file
splots <- list()
splots[[1]] <- cloglog_obstruct 
splots[[2]] <- cloglog_differ
splots[[3]] <- cloglog_extent
splots[[4]] <- cloglog_surg
splots[[5]] <- cloglog_node4
splots[[6]] <- cloglog_rx
cloglog_plot = arrange_ggsurvplots(splots, print = FALSE, ncol = 2, nrow = 3)

ggsave(cloglog_plot,file = "./plot/d.C-log-log-plots.pdf",width = 12,height = 15)
ggsave(cloglog_plot,file = "./plot/d.C-log-log-plots.png",width = 12,height = 15)
```

&nbsp;  


**Schoenfeld residuals**

```{r, message=FALSE, warning=FALSE}
czph <- cox.zph(coxph(Surv(time, status) ~ obstruct + differ + extent + surg + node4 + rx, data = colon.death))
schoenfeld_plot <- ggcoxzph(czph, font.main = 10, font.x = 10, font.y = 10, font.tickslab = 8,
                            point.alpha = 0.5, point.col = "grey25")

schoenfeld_plot
ggsave("./plot/d.schoenfeld residual_plots.pdf", arrangeGrob(grobs = schoenfeld_plot))
ggsave("./plot/d.schoenfeld residual_plots.png", arrangeGrob(grobs = schoenfeld_plot))
```
From the output above, the tests for covariates "obstruct", "node4", "differ" are statistically significant, and the global test is also statistically significant. Therefore, we can assume the violation of proportional hazards on these covariates, which requires corrections of non-proportional hazard ratio.



### 4.2.2 Test influential observations 

```{r, message=FALSE, warning=FALSE}
# check outliers in term of dfbeta
outlier_dfbeta <- ggcoxdiagnostics(coxph(Surv(time, status) ~ obstruct + differ + extent + surg + node4 + rx, data = colon.death), 
                                   type = "dfbeta", linear.predictions = FALSE, ggtheme = theme_bw())

ggsave(outlier_dfbeta, file = "./plot/d.outlier_dfbeta.pdf")
ggsave(outlier_dfbeta, file = "./plot/d.outlier_dfbeta.png")
```
It’s also possible to check outliers by visualizing the influence of each point, in terms of DFBETA - the impact on the coefficient of covariates in the model were that specific point to be removed from the data set. In general, we can identify the observations with positive and negative DFBETAs. Comparing the magnitudes of the largest dfbeta values to the regression coefficients suggests that none of the observations is terribly influential individually, even though some of the dfbeta values for extent are large compared with the others.

## 4.3 Corrections for violation of the PH Assumption
```{r, message=FALSE, warning=FALSE}
colon.death.inter <- colon.death %>% 
  mutate(rxt = as.numeric(rx)*log(time),
  differt = as.numeric(differ)*log(time),
  extentt = as.numeric(extent)*log(time),
  surgt = as.numeric(surg)*log(time),
  node4t = as.numeric(node4)*log(time),
  obstructt = as.numeric(obstruct)*log(time)) 

d.model.inter <- coxph(Surv(time, status) ~ obstruct + differ + extent + surg + node4 + rx + obstructt + differt + extentt + rxt + node4t + surgt, data = colon.death.inter)

summary(d.model.inter)
anova(d.model.inter)
```
Based on the test interaction for proportionality, the result shows that all the interactions of covaraites with 'log(time)' are significant (i.e., less than 0.05). Therefore, we can include these interactions with function of time as the method of PH assumption verification and solution to its violation. 

&nbsp;




## 4.4 Final model

With the inclusion of treatment, our final model is given by: Surv(time, status) ~ obstruct + differ + extent + surg + node4 + rx + obstructt + differt + extentt + surgt + rxt + node4t.

```{r, message=FALSE, warning=FALSE}
d.final.model <- coxph(Surv(time, status) ~ obstruct + differ + extent + surg + node4 + rx + obstructt + differt + extentt + rxt + node4t + surgt, data = colon.death.inter)
summary(d.final.model)
```

From the results of the summary function for the final mortality model, we see that after we control for all other covariates in the model the coefficient for covariate rxLev is -0.031, which indicates a protective effect. And the hazard rate of death for the group treated with rxlev is 3% less than observation group, with a p-value of 0.78. Furthermore, the confidence interval for the hazard ratio is (0.78, 1.21). 

On the other hand, the coefficient for covariate rxLev+5Fu is -0.36, which indicates a protective effect. And the hazard rate of death for the group treated with rxLev+5Fu is 32.2% less than observation group, with a p-value of 0.003. Furthermore, the confidence interval for the hazard ratio is (0.55, 0.89). 

&nbsp;


# 5. Discussion

We can now observe whether treatments Levamisole and Levamisole+5-FU help improve the survival rate in colon cancer patients from negative coefficients of different treatment groups. Our result indicates that the hazard rate for the group treated with Levamisole is 97% of what it is for the observation group. Since the p-value for the coefficient is 0.78 which is greater than 0.05, there is no significant evidence to indicate a difference between the hazard rate of the group treated with Levamisole and the hazard rate of the observation group. Therefore, we conclude that the treatment Levamisole is not effective on improving the survival probability in colon cancer patients.
On the other hand, our result indicates that the hazard rate for the group treated with Levamisole+5-FU is 67.8% of the hazard rate for the observation group. Since the p-value for the coefficient is close to 0, this indicates that there is a significant difference between the hazard rate of the group treated with Levamisole+5-FU and the hazard rate for the observation group. 
Therefore, we conclude that the treatment Levamisole+5-FU is effective on improving the survival rate in colon cancer patients. There is a 32.2% chance that patients who received the treatment Levamisole+5-FU survive longer than patients who do not receive any treatments and patients who received Levamisole alone.

&nbsp;


 
